

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Method &mdash; UltraNest 3.3.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="_static/icon.ico"/>
  
  
  
    <link rel="canonical" href="https://johannesbuchner.github.io/UltraNest/method.html"/>
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Basic usage" href="using-ultranest.html" />
    <link rel="prev" title="Installation" href="installation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> UltraNest
          

          
            
            <img src="_static/logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="readme.html">UltraNest</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Method</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#visualisation">Visualisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#literature">Literature</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#code-concepts">Code Concepts</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#spaces">Spaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="#nested-sampler-integrator">Nested sampler &amp; integrator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#constructing-mlfriends-regions">Constructing MLFriends regions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sampling-from-regions">Sampling from regions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#transformed-ellipsoid">Transformed ellipsoid</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="using-ultranest.html">Basic usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="priors.html">Specifying priors</a></li>
<li class="toctree-l1"><a class="reference internal" href="performance.html">Tour of the features</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="issues.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">Release Notes</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="example-sine-line.html">Time series fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="example-sine-modelcomparison.html">Model comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="example-sine-highd.html">Higher-dimensional fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="example-intrinsic-distribution.html">Tutorial: intrinsic distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="example-line.html">Tutorial: fitting a line</a></li>
<li class="toctree-l1"><a class="reference internal" href="example-outliers.html">Tutorial: distribution with outliers</a></li>
<li class="toctree-l1"><a class="reference internal" href="example-sine-bayesian-workflow.html">Bayesian workflow</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">UltraNest</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Method</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="method">
<h1>Method<a class="headerlink" href="#method" title="Permalink to this headline">¶</a></h1>
<p>UltraNest combines several methods to improve nested sampling,
and will be described in detail in a future paper. The key elements are:</p>
<ol class="arabic">
<li><p>constrained-likelihood sampling algorithm</p>
<p>For sampling a new, independent point, primarily implements MLFriends.
MLFriends places ellipsoids around each live point and draws from them.
The ellipsoid shape is determined by the live point distribution (Mahalanobis distance),
the ellipsoid size is determined by cross-validation.
For high-dimensional inference, parameter-free algorithms such as HARM and DyCHMC are available.</p>
</li>
<li><p>nested sampler</p>
<p>This component manages the live point population, and can add or remove points.
UltraNest supports several advanced strategies for injecting more points
when needed to populated clusters, to reach the effective sample size,
integration uncertainty or posterior accuracy.</p>
</li>
<li><p>nested integrator</p>
<p>This component assigns weights to the sampled points. UltraNest implements
a bootstrapping scheme that simulates other runs with fewer live points.
This gives robust and realistic uncertainties.</p>
</li>
<li><p>termination criterion</p>
<p>In principle, termination can occur when the dead, removed points have more
weight than the live points. However, in practice, very small peaks can be discovered
on relatively flat likelihood surfaces,
for example when fitting multiple components to a data series.
Therefore, UltraNest integrates until the live point weights are insignificant (<em>frac_remain=0.01</em>).
For noisy likelihoods, termination when the live points are within a tolerance of <em>Lepsilon</em> can be requested.</p>
</li>
</ol>
<div class="section" id="visualisation">
<h2>Visualisation<a class="headerlink" href="#visualisation" title="Permalink to this headline">¶</a></h2>
<p>The animation below gives an idea how the algorithm proceeds.
Choose different 2d target distributions to explore, and compare to a
simple MCMC algorithm.</p>
<iframe src="_static/mcmc-demo/app.html" style="width:100%; height:400px;"></iframe><ol class="arabic simple">
<li><p>Initially, points are drawn from the entire parameter space (green) according to the prior.</p></li>
<li><p>The lowest of these live point (worst fit) is removed, and a better one sought.
At each removal, the volume sampled by the live point shrinks by a constant
factor.</p></li>
<li><p>To still sample from the prior, MLFriends creates ellipsoids around all
live points and samples from them. The ellipsoid size is determined
by bootstrapping: Some points are randomly left out, and the ellipsoids
have to be large enough so that they could have been sampled. This is
repeated several times. In UltraNest, the ellipsoid shape is learnt
as well.</p></li>
<li><p>Nested sampling proceeds to the peak, keeping track of the likelihood.
The volume becomes smaller and smaller. At some point, the remainder
does not contribute any probability mass, and the exploration is finished.</p></li>
<li><p>The removed points are weighted by their likelihood and the volume they
represent. These are the posterior samples (histograms).</p></li>
</ol>
<p>The sampling can become inefficient, for example for high-dimensional
problems. UltraNest provides MCMC-based methods to find a new point.</p>
<p>The animation is based on work by Chi Feng <a class="reference external" href="https://chi-feng.github.io/mcmc-demo/">https://chi-feng.github.io/mcmc-demo/</a>
and is MIT licenced. The RadFriends implementation was contributed by Johannes Buchner.</p>
</div>
<div class="section" id="literature">
<h2>Literature<a class="headerlink" href="#literature" title="Permalink to this headline">¶</a></h2>
<p>On the theory behind nested sampling:</p>
<ul class="simple">
<li><p>Skilling, J. (2004): Nested sampling</p></li>
<li><p>Chopin, N. &amp; Robert, C. (2008): Properties of Nested Sampling</p></li>
<li><p>Evans, M. (2007): Discussion of nested sampling for Bayesian computations by John Skilling</p></li>
<li><p>Skilling, J. (2009): Nested sampling’s convergence</p></li>
<li><p>Walter, C. (2014): Point Process-based Monte Carlo estimation</p></li>
</ul>
<p>For an introduction of constrained-likelihood prior sampling methods and verification:</p>
<ul class="simple">
<li><p>Buchner, J. (2014): A statistical test for Nested Sampling algorithms</p></li>
<li><p>Higson, E.; Handley, W.; Hobson, M. &amp; Lasenby, A. (2019) NESTCHECK: diagnostic tests for nested sampling calculations</p></li>
<li><p>Buchner, J. (2021): Nested Sampling Methods</p></li>
</ul>
<p>On analysing many data sets:</p>
<ul class="simple">
<li><p>Buchner, J. (2019): Collaborative Nested Sampling: Big Data versus Complex Physical Models</p></li>
</ul>
<div class="section" id="code-concepts">
<h3>Code Concepts<a class="headerlink" href="#code-concepts" title="Permalink to this headline">¶</a></h3>
<p>This content gives some hints for those who want to dive into the codebase.</p>
</div>
</div>
<div class="section" id="spaces">
<h2>Spaces<a class="headerlink" href="#spaces" title="Permalink to this headline">¶</a></h2>
<p>UltraNest maps four spaces:</p>
<ul class="simple">
<li><p>u: The unit cube space</p></li>
<li><p>t: A affine projection of the unit cube space (called transformLayer)</p></li>
<li><p>p: The physical parameter space</p></li>
<li><p>L/logl: Likelihood values</p></li>
</ul>
<p>The transformations are made as follows:</p>
<ul class="simple">
<li><p>unit cube &lt;-&gt; transformLayer space: region.transformLayer.transform() and untransform()</p></li>
<li><p>unit cube -&gt; physical parameter space: user-provided prior transform function</p></li>
<li><p>physical parameter space -&gt; likelihood values: user-provided likelihood function</p></li>
</ul>
</div>
<div class="section" id="nested-sampler-integrator">
<h2>Nested sampler &amp; integrator<a class="headerlink" href="#nested-sampler-integrator" title="Permalink to this headline">¶</a></h2>
<p>A tree-based concept envisions the full prior volume as the root of a tree.
Branches indicate divisions. The first children of the tree root are
sampled directly from the prior, and are called <em>roots</em> in the code (although
they are in reality the first branches).</p>
<p>The nested sampling algorithm is a breadth-first search of this tree,
with nodes expanded as needed. Replacements of a node by its children
is a nested sampling shrinkage. When children are added to nodes is
driven by software agents. These agents can optimize for various strategies.</p>
<p>Four strategies are implemented. They can be independently activated by the user:</p>
<ul class="simple">
<li><p>Obtain a logz error below a threshold (<em>dlogz</em>)</p></li>
<li><p>Obtain a certain number of effective samples (<em>min_ess</em>)</p></li>
<li><p>Keep a certain number of live points (width of tree) per cluster (<em>cluster_num_live_points</em>).</p></li>
<li><p>Obtain a posterior uncertainty below a threshold (<em>dKL</em>).</p></li>
</ul>
<p>The breadth-first search starts with the <em>roots</em>. Additionally,
alternative breadth-first searches with some <em>roots</em> left out
(bootstrapping) is simulated simultaneously. The breadth-first search
computes logz and adds uncertainty contributions from:</p>
<ul class="simple">
<li><p>The limited shrinkage estimate (information H)</p></li>
<li><p>The bootstraps (simulating alternative, repeated nested sampling runs)</p></li>
<li><p>The noise in shrinkage estimates (by sampling it a binomial distribution in each bootstrap realisation)</p></li>
</ul>
<p>The combination makes UltraNest’s logz uncertainties very reliable.</p>
</div>
<div class="section" id="constructing-mlfriends-regions">
<h2>Constructing MLFriends regions<a class="headerlink" href="#constructing-mlfriends-regions" title="Permalink to this headline">¶</a></h2>
<p>Robust likelihood-constrained prior sampling (LCPS) is achieved with the
parameter-free <strong>MLFriends</strong> algorithm.</p>
<p>MLFriends (Buchner 2019) is a substantial improvement upon the original RadFriends algorithm (2014 paper).
RadFriends obtains regions by leaving some points out, and testing how
large spheres around the live points have to be to be able to recover them.
This bootstrapping is repeated many times (bootstrapping), to be robust.
This way, RadFriends learns automatically about multiple modes.
RadFriends is slow, because it does not learn the relative sizes of different parameters,
nor the correlation between them. MLFriends (2019 paper) improves by obtaining the covariance
of the live points, and thus uses a Mahalanobis distance.
This learned metric helps reduce the region, and accelerates sampling.</p>
<p>At the same time, MLFriends provides natural agglomerate clustering – points within each others
ellipsoids belong to the same cluster.
UltraNest improves MLFriends further by iteratively</p>
<ol class="arabic simple">
<li><p>compute MLFriends ellipsoid radius with a metric (euclidean initially)</p></li>
<li><p>Identify clusters with that radius</p></li>
<li><p>Shift clusters on top of each other and learn a new metric from the covariance.</p></li>
</ol>
<p>This scheme iteratively improves the metric, and is robust when clusters appear (
otherwise the metric may be primarily measuring the distance between clusters).</p>
<p>Finally, UltraNest only accepts new regions when they reduce the size of the sampling space.
This is necessary because when a cluster disappears, it has few points and would
be merged back into the bulk, increasing the radius drastically. Requiring shrinkage
avoids this problem. By starting the bootstrapping always with the same random numbers,
over-shrinkage by repeated invocations is avoided.</p>
<p>UltraNest also adds a enveloping ellipsoid. This can help in
mono-modal gaussian problems. Contrary to Mukherjee, Parkinson &amp; Liddle (2006),
the ellipsoid enlargement is learned by bootstrapping, and is thus robust and
well-justified. Both regions are used as filters.</p>
<p>Another improvement is that in MPI-parallelised runs, UltraNest
distributes the RadFriends bootstraps. This makes clustering very fast
(MultiNest has to stop for clustering on the master node).</p>
</div>
<div class="section" id="sampling-from-regions">
<h2>Sampling from regions<a class="headerlink" href="#sampling-from-regions" title="Permalink to this headline">¶</a></h2>
<p>UltraNest samples in four region sampling schemes:</p>
<ul class="simple">
<li><p>Sample from unit cube, filter with MLFriends &amp; ellipsoid</p></li>
<li><p>Sample from MLFriends points, filter with unit cube &amp; ellipsoid</p></li>
<li><p>Sample from MLFriends region bounding box, filter with unit cube &amp; ellipsoid</p></li>
<li><p>Sample from ellipsoid, filter with unit cube &amp; MLFriends region</p></li>
</ul>
<p>UltraNest switches between these methods when the current on becomes inefficient.
Efficiency here means being able to draw points, not whether they are
above the likelihood contour.</p>
</div>
<div class="section" id="transformed-ellipsoid">
<h2>Transformed ellipsoid<a class="headerlink" href="#transformed-ellipsoid" title="Permalink to this headline">¶</a></h2>
<p>Additionally, a ellipsoid is also built in transformed space and used
for rejecting points. This is only done when the transform is non-linear.
The parameter transformation, perhaps being closer to the data constraints,
allows the ellipsoid to follow.</p>
<p>Users can thus tune the transform to improve the sampling efficiency.</p>
<p>For example:</p>
<ul class="simple">
<li><p>L-shapes: when two parameters are added with a log-uniform prior, it could be wise to transform them into linear space.</p></li>
<li><p>funnel-shapes: in hierarchical models, the variance and means should be decorrelated – providing the means as a fraction of the variance allows the ellipsoid to follow funnel-shapes.</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="using-ultranest.html" class="btn btn-neutral float-right" title="Basic usage" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="installation.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2014-2020, Johannes Buchner

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>